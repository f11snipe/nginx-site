#!/bin/bash

if [[ $EUID -ne 0 ]]; then
  fail "This script must be run as root :)" 1
fi

site=f11snipe.sh
conf=/etc/nginx/sites-available/$site.conf
link=/etc/nginx/sites-enabled/$site.conf
web=/var/www
public=$web/$site
admin=$web/admin.$site

log "Installing $site nginx config ..."
cp src/conf/$site.conf $conf

if [ ! -L ]; then
  log "Enabling new conf (link $link -> $conf) ..."
  ln -s $conf $link
fi

log "Installing public web files ..."
mkdir -p $public
cp -r src/public/* $public/

log "Installing admin web files ..."
mkdir -p $admin
cp -r src/admin/* $admin/

log "Testing nginx configuration ..."
nginx -t

if [ $? -ne 0 ]; then
  fail "Failed nginx test. Please review configuration and any errors above." $?
fi

log "Restarting nginx service ..."
service nginx restart
service nginx status

error() {
  red='\033[0;31m'
  nocolor='\033[0m'
  prefix="======>>  "
  suffix="  <<======"
  echo -e "${red}${prefix}${1}${suffix}${nocolor}"
}

log() {
  yellow='\033[0;33m'
  nocolor='\033[0m'
  prefix="======>>  "
  suffix="  <<======"
  echo -e "${yellow}${prefix}${1}${suffix}${nocolor}"
}

fail() {
  msg=${1:-Failure}
  code=${2:-1}

  error "FATAL: $msg"

  exit $code
}